import androidx.compose.desktop.ui.tooling.preview.Preview
import androidx.compose.foundation.clickable
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.verticalScroll
import androidx.compose.material.*
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.PlayArrow
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.window.Window
import androidx.compose.ui.window.application
import com.vowser.client.ui.graph.*
import com.vowser.client.data.*
import com.vowser.client.navigation.*
import kotlinx.coroutines.launch

@Composable
@Preview
fun TestGraphApp() {
    // Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî - ÌôïÏû•Îêú ÎÑ§Ïù¥Î≤Ñ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
    val navigationGraph = remember { ExpandedNaverDataGenerator.createExpandedNaverData() }
    val navigationProcessor = remember { NavigationProcessor(navigationGraph) }
    val coroutineScope = rememberCoroutineScope()
    
    // UI ÏÉÅÌÉú
    var currentCommand by remember { mutableStateOf("") }
    var navigationResult by remember { mutableStateOf<NavigationResult?>(null) }
    var isProcessing by remember { mutableStateOf(false) }
    var selectedCommand by remember { mutableStateOf<String?>(null) }
    
    // ÏÇ¨Ï†Ñ Ï†ïÏùòÎêú Î™ÖÎ†πÏñ¥Îì§ - ÌôïÏû•Îêú Î™ÖÎ†πÏñ¥ ÏÑ∏Ìä∏
    val sampleCommands = remember {
        listOf(
            "Ïù∏Í∏∞ ÏõπÌà∞ Î≥¥Í≥† Ïã∂Ïñ¥",
            "Î°úÎß®Ïä§ ÏõπÌà∞ ÏùΩÍ≥† Ïã∂Ïñ¥",
            "Ï†ïÏπò Îâ¥Ïä§ ÏïåÎ†§Ï§ò",
            "ÏïºÍµ¨ Îâ¥Ïä§ Î≥¥Í≥† Ïã∂Ïñ¥",
            "ÌôîÏû•Ìíà ÏáºÌïëÌïòÍ≥† Ïã∂Ïñ¥",
            "ÏöîÎ¶¨ Î†àÏãúÌîº Ï∞æÏïÑÏ§ò",
            "ÎìúÎùºÎßà Î≥¥Í≥† Ïã∂Ïñ¥",
            "ÏºÄÏù¥Ìåù Îì£Í≥† Ïã∂Ïñ¥",
            "Ìä∏Î°úÌä∏ ÏùåÏïÖ Îì£Í≥† Ïã∂Ïñ¥",
            "Í∞§Îü≠Ïãú Ìè∞ ÏÇ¨Í≥† Ïã∂Ïñ¥",
            "Ïò§Îäò ÎÇ†Ïî® Ïñ¥Îïå?",
            "Ïã¨Ïã¨ÌïúÎç∞ Ïû¨Î∞åÎäî Í±∞ ÏóÜÏùÑÍπå?",
            "Î≠ê Ìï† Ïàò ÏûàÏñ¥?"
        )
    }
    
    MaterialTheme {
        Row(
            modifier = Modifier
                .fillMaxSize()
                .padding(16.dp),
            horizontalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // Ï¢åÏ∏° Ìå®ÎÑê: Î™ÖÎ†πÏñ¥ ÏûÖÎ†• Î∞è Í≤∞Í≥º
            Column(
                modifier = Modifier
                    .weight(0.4f)
                    .verticalScroll(rememberScrollState()),
                verticalArrangement = Arrangement.spacedBy(16.dp)
            ) {
                // Ìó§Îçî
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    elevation = 4.dp,
                    backgroundColor = MaterialTheme.colors.primary
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp)
                    ) {
                        Text(
                            text = "üéôÔ∏è Í∞ÄÎçòÍ∏∏ (Desire Path)",
                            style = MaterialTheme.typography.h5,
                            color = Color.White
                        )
                        Text(
                            text = "ÏùåÏÑ± Î™ÖÎ†π Í∏∞Î∞ò Ïõπ Ï†ëÍ∑ºÏÑ± ÎèÑÍµ¨",
                            style = MaterialTheme.typography.caption,
                            color = Color.White.copy(alpha = 0.8f)
                        )
                    }
                }
                
                // Î™ÖÎ†πÏñ¥ ÏûÖÎ†•
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    elevation = 2.dp
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        verticalArrangement = Arrangement.spacedBy(12.dp)
                    ) {
                        Text(
                            text = "ÏùåÏÑ± Î™ÖÎ†πÏñ¥",
                            style = MaterialTheme.typography.h6
                        )
                        
                        OutlinedTextField(
                            value = currentCommand,
                            onValueChange = { currentCommand = it },
                            modifier = Modifier.fillMaxWidth(),
                            placeholder = { Text("Ïòà: Ïù∏Í∏∞ ÏõπÌà∞ Î≥¥Í≥† Ïã∂Ïñ¥") },
                            enabled = !isProcessing
                        )
                        
                        Button(
                            onClick = {
                                if (currentCommand.isNotBlank()) {
                                    coroutineScope.launch {
                                        isProcessing = true
                                        try {
                                            navigationResult = navigationProcessor.processVoiceCommand(currentCommand)
                                        } finally {
                                            isProcessing = false
                                        }
                                    }
                                }
                            },
                            modifier = Modifier.fillMaxWidth(),
                            enabled = currentCommand.isNotBlank() && !isProcessing
                        ) {
                            if (isProcessing) {
                                CircularProgressIndicator(
                                    modifier = Modifier.size(16.dp),
                                    color = Color.White
                                )
                                Spacer(modifier = Modifier.width(8.dp))
                                Text("Ï≤òÎ¶¨ Ï§ë...")
                            } else {
                                Text("üîç Í≤ΩÎ°ú Ï∞æÍ∏∞")
                            }
                        }
                    }
                }
                
                // ÏÉòÌîå Î™ÖÎ†πÏñ¥
                Card(
                    modifier = Modifier.fillMaxWidth(),
                    elevation = 2.dp
                ) {
                    Column(
                        modifier = Modifier.padding(16.dp),
                        verticalArrangement = Arrangement.spacedBy(8.dp)
                    ) {
                        Text(
                            text = "üí° ÏÉòÌîå Î™ÖÎ†πÏñ¥",
                            style = MaterialTheme.typography.h6
                        )
                        
                        sampleCommands.forEach { command ->
                            Card(
                                modifier = Modifier
                                    .fillMaxWidth()
                                    .clickable { 
                                        currentCommand = command
                                        selectedCommand = command
                                        // ÏûêÎèôÏúºÎ°ú Î™ÖÎ†π Ïã§Ìñâ
                                        coroutineScope.launch {
                                            isProcessing = true
                                            try {
                                                navigationResult = navigationProcessor.processVoiceCommand(command)
                                            } finally {
                                                isProcessing = false
                                            }
                                        }
                                    },
                                backgroundColor = if (selectedCommand == command) {
                                    MaterialTheme.colors.primary.copy(alpha = 0.1f)
                                } else Color.White,
                                elevation = if (selectedCommand == command) 4.dp else 1.dp,
                                shape = RoundedCornerShape(8.dp)
                            ) {
                                Row(
                                    modifier = Modifier.padding(12.dp),
                                    verticalAlignment = Alignment.CenterVertically
                                ) {
                                    Icon(
                                        imageVector = Icons.Filled.PlayArrow,
                                        contentDescription = null,
                                        modifier = Modifier.size(16.dp),
                                        tint = MaterialTheme.colors.primary
                                    )
                                    Spacer(modifier = Modifier.width(8.dp))
                                    Text(
                                        text = command,
                                        style = MaterialTheme.typography.body2,
                                        fontWeight = if (selectedCommand == command) FontWeight.Medium else FontWeight.Normal
                                    )
                                }
                            }
                        }
                    }
                }
                
                // Í≤∞Í≥º ÌëúÏãú
                navigationResult?.let { result ->
                    Card(
                        modifier = Modifier.fillMaxWidth(),
                        elevation = 2.dp,
                        backgroundColor = if (result.success) {
                            Color(0xFFE8F5E8)
                        } else {
                            Color(0xFFFFF3E0)
                        }
                    ) {
                        Column(
                            modifier = Modifier.padding(16.dp),
                            verticalArrangement = Arrangement.spacedBy(8.dp)
                        ) {
                            Text(
                                text = if (result.success) "‚úÖ ÏÑ±Í≥µ" else "‚ö†Ô∏è ÏïåÎ¶º",
                                style = MaterialTheme.typography.h6,
                                color = if (result.success) Color(0xFF2E7D32) else Color(0xFFE65100)
                            )
                            
                            Text(
                                text = result.message,
                                style = MaterialTheme.typography.body2
                            )
                            
                            if (result.success && result.estimatedTime > 0) {
                                Divider()
                                Row(
                                    modifier = Modifier.fillMaxWidth(),
                                    horizontalArrangement = Arrangement.SpaceBetween
                                ) {
                                    Text("ÏòàÏÉÅ ÏãúÍ∞Ñ: ${result.estimatedTime}Ï¥à")
                                    Text("ÌÅ¥Î¶≠ Ïàò: ${result.totalClicks}Î≤à")
                                }
                            }
                        }
                    }
                }
            }
            
            // Ïö∞Ï∏° Ìå®ÎÑê: Í∑∏ÎûòÌîÑ ÏãúÍ∞ÅÌôî
            Column(
                modifier = Modifier.weight(0.6f)
            ) {
                val currentVisualizationData = remember(navigationResult) {
                    navigationResult?.visualizationData 
                        ?: navigationProcessor.getCurrentVisualizationData()
                }
                
                AnimatedNavigationGraph(
                    nodes = currentVisualizationData.nodes,
                    edges = currentVisualizationData.edges,
                    highlightedPath = currentVisualizationData.highlightedPath,
                    activeNodeId = currentVisualizationData.activeNodeId,
                    isNavigationActive = isProcessing || (navigationResult?.success == true),
                    modifier = Modifier.fillMaxSize()
                ) { node ->
                    println("ÌÅ¥Î¶≠Îêú ÎÖ∏Îìú: ${node.label} (${node.id})")
                    // ÎÖ∏Îìú ÌÅ¥Î¶≠ Ïãú ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú Îì± Ï∂îÍ∞Ä Í∏∞Îä• Íµ¨ÌòÑ Í∞ÄÎä•
                }
            }
        }
    }
}

fun main() = application {
    Window(
        onCloseRequest = ::exitApplication,
        title = "ÎÑ§Ìä∏ÏõåÌÅ¨ Í∑∏ÎûòÌîÑ ÌÖåÏä§Ìä∏ - Í∞ÄÎçòÍ∏∏ ÌîÑÎ°úÌÜ†ÌÉÄÏûÖ"
    ) {
        TestGraphApp()
    }
}